# Ecosystem Assessment - Weekly Deep Codebase Analysis
#
# SPHERE 1: Deep sustained analysis using OpenAI Codex
#
# Pattern:
# 1. Codex runs for hours analyzing entire codebase
# 2. Generates reports in /reports directory
# 3. Creates starting branch with reports force-committed
# 4. Matrix outputs to Jules jobs for improvements
#
# Reports are gitignored but force-committed to the starting branch
# so Jules jobs can access them via include_last_commit

name: Ecosystem Assessment

on:
  schedule:
    # Weekly: Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  
  workflow_dispatch:
    inputs:
      repository:
        description: 'Repository to analyze (owner/repo)'
        required: false
        type: string
      skip_improvements:
        description: 'Skip Jules improvement jobs'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  TARGET_REPO: ${{ inputs.repository || github.repository }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 1: Deep Analysis with Codex
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  analyze:
    name: Deep Codebase Analysis
    runs-on: ubuntu-latest
    outputs:
      branch: ${{ steps.branch.outputs.name }}
      improvements: ${{ steps.parse.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Setup environment
        run: |
          # Install tools Codex might need
          npm install -g pnpm
          pip install uv
          
          # Create reports directory
          mkdir -p reports
          
          # Ensure reports is gitignored but we can force-add
          echo "reports/" >> .gitignore || true

      - name: Create analysis branch
        id: branch
        run: |
          BRANCH="assessment/weekly-$(date +%Y-%m-%d)"
          git checkout -b "$BRANCH"
          echo "name=$BRANCH" >> $GITHUB_OUTPUT

      - name: Run Codex Deep Analysis
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: codex-mini-latest
          sandbox: danger-full-access
          effort: high
          prompt-file: .github/prompts/assessment.md
          output-file: reports/analysis.md

      - name: Parse improvements matrix
        id: parse
        run: |
          # Extract improvement areas from Codex output
          # Expected format in reports/analysis.md:
          # ## Improvements
          # - area: test-coverage
          #   priority: high
          #   description: ...
          
          if [ -f reports/improvements.json ]; then
            MATRIX=$(jq -c '.' < reports/improvements.json)
          else
            # Default matrix if Codex didn't generate one
            MATRIX='[{"area":"test-coverage","priority":"high"},{"area":"documentation","priority":"medium"},{"area":"security","priority":"high"},{"area":"code-quality","priority":"medium"}]'
          fi
          
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

      - name: Force commit reports
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Force add reports even though gitignored
          git add -f reports/
          git commit -m "chore: add weekly assessment reports

          Generated by Ecosystem Assessment workflow.
          These reports are used by Jules improvement jobs."
          
          git push -u origin "${{ steps.branch.outputs.name }}"

      - name: Upload reports artifact
        uses: actions/upload-artifact@v4
        with:
          name: assessment-reports
          path: reports/
          retention-days: 7

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 2: Jules Improvement Jobs (Matrix)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  improve:
    name: Improve ${{ matrix.area }}
    needs: analyze
    if: ${{ !inputs.skip_improvements }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        include: ${{ fromJson(needs.analyze.outputs.improvements) }}
    steps:
      - name: Invoke Jules for ${{ matrix.area }}
        uses: google-labs-code/jules-action@v1
        with:
          jules_api_key: ${{ secrets.GOOGLE_JULES_API_KEY }}
          starting_branch: ${{ needs.analyze.outputs.branch }}
          include_last_commit: true
          prompt: |
            You are an improvement agent focused on: ${{ matrix.area }}
            Priority: ${{ matrix.priority }}
            
            CONTEXT:
            - The assessment reports are in the /reports directory
            - Read reports/analysis.md for the full codebase analysis
            - Read reports/${{ matrix.area }}.md if it exists for specific findings
            
            YOUR TASK:
            1. Review the assessment reports for ${{ matrix.area }} issues
            2. Implement fixes for the highest priority items
            3. Run tests to verify your changes
            4. Keep changes focused and under 500 lines total
            
            CLEANUP:
            Before creating your PR, remove the /reports directory from your branch.
            The reports are only needed for context, not for the final PR.
            
            PR GUIDELINES:
            - Title: "improve(${{ matrix.area }}): <brief description>"
            - Reference the assessment findings in your PR body
            - Include before/after metrics if applicable

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PHASE 3: Summary Issue
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summarize:
    name: Create Summary Issue
    needs: [analyze, improve]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download reports
        uses: actions/download-artifact@v4
        with:
          name: assessment-reports
          path: reports/

      - name: Create or update summary issue
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          TITLE="Weekly Assessment: $(date +%Y-%m-%d)"
          
          # Build issue body
          BODY=$(cat <<'ISSUE_EOF'
          # ğŸ“Š Weekly Codebase Assessment
          
          **Date:** $(date +%Y-%m-%d)
          **Branch:** ${{ needs.analyze.outputs.branch }}
          
          ## Analysis Summary
          
          $(cat reports/analysis.md 2>/dev/null | head -100 || echo "See attached reports")
          
          ## Improvement Jobs
          
          | Area | Status |
          |------|--------|
          ${{ needs.improve.result == 'success' && '| All | âœ… Complete |' || '| See workflow | âš ï¸ Check logs |' }}
          
          ## Next Steps
          
          Review the PRs created by Jules and merge as appropriate.
          
          ---
          <sub>Generated by Ecosystem Assessment workflow</sub>
          ISSUE_EOF
          )
          
          gh issue create --repo "${{ github.repository }}" \
            --title "$TITLE" \
            --body "$BODY" \
            --label "assessment,automated"

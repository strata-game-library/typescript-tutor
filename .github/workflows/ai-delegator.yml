# AI Delegator - Routes AI agent requests from comments
# Supports: @claude, /jules, /cursor
name: AI Delegator

on:
  issue_comment:
    types: [created]

# No workflow-level permissions - job level only
permissions: {}

jobs:
  # ════════════════════════════════════════════════════════════════
  # CLAUDE: @claude mentions in issues/PRs
  # ════════════════════════════════════════════════════════════════
  claude:
    name: Claude Agent
    if: |
      contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: claude-${{ github.event.issue.number || github.event.pull_request.number }}
      cancel-in-progress: false
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Check API Key
        id: check-key
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::ANTHROPIC_API_KEY not configured"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check-key.outputs.available == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Claude Code Action
        if: steps.check-key.outputs.available == 'true'
        uses: anthropics/claude-code-action@c9ec2b02b40ac0444c6716e51d5e19ef2e0b8d00 # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: "cursor[bot],jules[bot],google-labs-jules[bot],copilot-swe-agent[bot],dependabot[bot],renovate[bot],github-actions[bot]"
          additional_permissions: |
            actions: read
          track_progress: true
          prompt: |
            You are helping with ${{ github.repository }}.
            
            Context: ${{ github.event.issue.pull_request && 'Pull Request' || 'Issue' }} #${{ github.event.issue.number }}
            
            First, read CLAUDE.md, AGENTS.md, or README.md to understand the project.
            Then address the user's request in their comment.

          claude_args: |
            --allowedTools "Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(pnpm:*),Bash(npm:*),Bash(npx:*),Bash(bun:*),Bash(gh:*),mcp__github__get_issue,mcp__github__update_issue,mcp__github__add_issue_comment,mcp__github__list_issues,mcp__github__search_issues,mcp__github__get_pull_request,mcp__github__get_pull_request_diff,mcp__github__list_pull_request_commits,mcp__github__create_pull_request_review,mcp__github__add_pull_request_comment,mcp__github__create_pull_request,mcp__github__list_pull_requests,mcp__github__get_file_contents,mcp__github__list_files,mcp__github__create_or_update_file,mcp__github_inline_comment__create_inline_comment,mcp__github_ci__get_ci_status,mcp__github_ci__get_workflow_run_details,mcp__github_ci__download_job_log,mcp__github_ci__list_workflow_runs"

  # ════════════════════════════════════════════════════════════════
  # CONTROL-CENTER: /jules, /cursor commands
  # ════════════════════════════════════════════════════════════════
  build:
    name: Build Control Center
    if: |
      github.event.issue.pull_request == null &&
      (contains(github.event.comment.body, '/jules') || contains(github.event.comment.body, '/cursor'))
    permissions:
      contents: read
    uses: jbcom/control-center/.github/workflows/control-center-build.yml@main

  delegate:
    name: Delegate to AI
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Download binary
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: control-center-binary
          path: /tmp
          run-id: ${{ github.run_id }}
          github-token: ${{ secrets.CI_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Run delegator
        env:
          GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          COMMAND_BODY: ${{ github.event.comment.body }}
        run: |
          chmod +x /tmp/control-center
          /tmp/control-center delegator \
            --repo "${{ github.repository }}" \
            --issue "${{ github.event.issue.number }}" \
            --command "$COMMAND_BODY" \
            --log-level info

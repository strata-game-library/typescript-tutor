# Ecosystem Control - AI Agent Orchestration
# Routes @cascade commands to appropriate AI agents via pure curl
#
# Responsibilities:
# - Parse @cascade commands from issue/PR comments
# - Route to Claude, Cursor, Jules, or Ollama
# - Execute targeted AI actions against tracking issues
#
# All API calls via curl - zero dependencies

name: Ecosystem Control

on:
  # Commands on issues or PRs
  issue_comment:
    types: [created]
  # State transitions on tracking issues
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: control-${{ github.event.issue.number }}
  cancel-in-progress: false  # Don't cancel AI work

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # ROUTER: Parse command and determine agent
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  route:
    name: Route Command
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '@cascade')
    runs-on: ubuntu-latest
    outputs:
      agent: ${{ steps.parse.outputs.agent }}
      task: ${{ steps.parse.outputs.task }}
      issue_num: ${{ steps.parse.outputs.issue_num }}
      is_pr: ${{ steps.parse.outputs.is_pr }}
      repo: ${{ steps.parse.outputs.repo }}
      branch: ${{ steps.parse.outputs.branch }}
    steps:
      - name: Parse Command
        id: parse
        env:
          COMMENT: ${{ github.event.comment.body }}
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          IS_PR="${{ github.event.issue.pull_request != null }}"
          
          echo "issue_num=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "is_pr=$IS_PR" >> $GITHUB_OUTPUT
          echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
          
          # Extract task (everything after @cascade)
          TASK=$(echo "$COMMENT" | sed 's/.*@cascade//' | xargs)
          echo "task=$TASK" >> $GITHUB_OUTPUT
          
          # Get branch if PR
          if [ "$IS_PR" = "true" ]; then
            BRANCH=$(gh pr view $ISSUE_NUM --repo "${{ github.repository }}" --json headRefName --jq '.headRefName' 2>/dev/null || echo "main")
          else
            BRANCH="main"
          fi
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          
          # Route based on keywords
          AGENT="claude"  # default
          
          if echo "$TASK" | grep -qiE "refactor|multi-file|large|migrate"; then
            AGENT="jules"
          elif echo "$TASK" | grep -qiE "debug|investigate|complex|fix ci"; then
            AGENT="cursor"
          elif echo "$TASK" | grep -qiE "quick|explain|what|why|how|question|\?"; then
            AGENT="ollama"
          fi
          
          echo "agent=$AGENT" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Routing to: $AGENT"

      - name: Acknowledge
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          IS_PR: ${{ github.event.issue.pull_request != null }}
          AGENT: ${{ steps.parse.outputs.agent }}
          TASK: ${{ steps.parse.outputs.task }}
          REPO: ${{ github.repository }}
        run: |
          # All values passed via env to prevent code injection
          BODY=$(cat <<BODY_EOF
          ğŸŒŠ **CASCADE** â†’ **$AGENT**
          
          Task: $TASK
          BODY_EOF
          )
          
          if [ "$IS_PR" = "true" ]; then
            gh pr comment "$ISSUE_NUM" --repo "$REPO" --body "$BODY"
          else
            gh issue comment "$ISSUE_NUM" --repo "$REPO" --body "$BODY"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CLAUDE: Via anthropics action (already installed)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  claude:
    name: Claude
    needs: route
    if: needs.route.outputs.agent == 'claude'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - uses: anthropics/claude-code-action@c9ec2b02b40ac0444c6716e51d5e19ef2e0b8d00 # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: '*'
          trigger_phrase: '@cascade'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # CURSOR: Pure curl to Cursor Cloud Agent API
  # https://cursor.com/docs/cloud-agent/api/endpoints
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  cursor:
    name: Cursor
    needs: route
    if: needs.route.outputs.agent == 'cursor'
    runs-on: ubuntu-latest
    steps:
      - name: Launch Cursor Agent
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          TASK: ${{ needs.route.outputs.task }}
          REPO: ${{ needs.route.outputs.repo }}
          BRANCH: ${{ needs.route.outputs.branch }}
          ISSUE_NUM: ${{ needs.route.outputs.issue_num }}
          IS_PR: ${{ needs.route.outputs.is_pr }}
        run: |
          # All values passed via env to prevent code injection
          echo "ğŸ¤– Launching Cursor agent..."
          echo "   Repo: $REPO"
          echo "   Branch: $BRANCH"
          echo "   Task: $TASK"
          
          # Launch agent via Cursor API
          # https://cursor.com/docs/cloud-agent/api/endpoints#launch-an-agent
          RESPONSE=$(curl -sf -X POST "https://api.cursor.com/v0/agents" \
            -u "$CURSOR_API_KEY:" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg text "$TASK" \
              --arg repo "$REPO" \
              --arg branch "$BRANCH" \
              '{
                prompt: {text: $text},
                source: {
                  repository: $repo,
                  branch: $branch
                }
              }')" 2>&1) || RESPONSE=""
          
          if [ -z "$RESPONSE" ]; then
            echo "âŒ Failed to launch Cursor agent"
            BODY="âŒ **Cursor Agent Failed**

          Could not launch agent. Check CURSOR_API_KEY."
          else
            AGENT_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
            AGENT_URL=$(echo "$RESPONSE" | jq -r '.url // empty')
            
            echo "âœ… Cursor agent launched: $AGENT_ID"
            
            BODY="ğŸ¤– **Cursor Agent Launched**

          | Field | Value |
          |-------|-------|
          | Agent ID | \`$AGENT_ID\` |
          | Repository | \`$REPO\` |
          | Branch | \`$BRANCH\` |

          [View Agent]($AGENT_URL)

          Task:
          \`\`\`
          $TASK
          \`\`\`"
          fi
          
          # Post result
          if [ "$IS_PR" = "true" ]; then
            gh pr comment $ISSUE_NUM --repo "${{ github.repository }}" --body "$BODY"
          else
            gh issue comment $ISSUE_NUM --repo "${{ github.repository }}" --body "$BODY"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JULES: Pure curl to Google Jules API
  # https://developers.google.com/jules/api/reference/rest
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  jules:
    name: Jules
    needs: route
    if: needs.route.outputs.agent == 'jules'
    runs-on: ubuntu-latest
    steps:
      - name: Create Jules Session
        env:
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          TASK: ${{ needs.route.outputs.task }}
          REPO: ${{ needs.route.outputs.repo }}
          BRANCH: ${{ needs.route.outputs.branch }}
          ISSUE_NUM: ${{ needs.route.outputs.issue_num }}
          IS_PR: ${{ needs.route.outputs.is_pr }}
        run: |
          # All values passed via env to prevent code injection
          # Parse owner/repo
          OWNER="${REPO%%/*}"
          REPO_NAME="${REPO##*/}"
          
          echo "ğŸ¤– Creating Jules session..."
          echo "   Source: sources/github/$OWNER/$REPO_NAME"
          echo "   Branch: $BRANCH"
          echo "   Task: $TASK"
          
          # Create session via Jules API
          # https://developers.google.com/jules/api/reference/rest/v1alpha/sessions/create
          RESPONSE=$(curl -sf -X POST "https://jules.googleapis.com/v1alpha/sessions" \
            -H "X-Goog-Api-Key: $GOOGLE_JULES_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg prompt "$TASK" \
              --arg source "sources/github/$OWNER/$REPO_NAME" \
              --arg branch "$BRANCH" \
              '{
                prompt: $prompt,
                sourceContext: {
                  source: $source,
                  githubRepoContext: {
                    startingBranch: $branch
                  }
                },
                automationMode: "AUTO_CREATE_PR"
              }')" 2>&1) || RESPONSE=""
          
          if [ -z "$RESPONSE" ]; then
            echo "âŒ Failed to create Jules session"
            BODY="âŒ **Jules Session Failed**

          Could not create session. Check GOOGLE_JULES_API_KEY."
          else
            SESSION_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
            SESSION_URL=$(echo "$RESPONSE" | jq -r '.url // empty')
            SESSION_STATE=$(echo "$RESPONSE" | jq -r '.state // "UNKNOWN"')
            
            echo "âœ… Jules session created: $SESSION_ID"
            
            BODY="ğŸ¤– **Jules Session Created**

          | Field | Value |
          |-------|-------|
          | Session ID | \`$SESSION_ID\` |
          | State | \`$SESSION_STATE\` |
          | Source | \`sources/github/$OWNER/$REPO_NAME\` |
          | Branch | \`$BRANCH\` |
          | Mode | \`AUTO_CREATE_PR\` |

          [View Session]($SESSION_URL)

          Task:
          \`\`\`
          $TASK
          \`\`\`

          Jules will create a PR when the work is complete."
          fi
          
          # Post result
          if [ "$IS_PR" = "true" ]; then
            gh pr comment $ISSUE_NUM --repo "${{ github.repository }}" --body "$BODY"
          else
            gh issue comment $ISSUE_NUM --repo "${{ github.repository }}" --body "$BODY"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # OLLAMA: Pure curl to Ollama Cloud API
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ollama:
    name: Ollama
    needs: route
    if: needs.route.outputs.agent == 'ollama'
    runs-on: ubuntu-latest
    steps:
      - name: Query Ollama
        env:
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
          OLLAMA_API_URL: ${{ vars.OLLAMA_API_URL || 'https://api.ollama.com' }}
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          TASK: ${{ needs.route.outputs.task }}
          ISSUE_NUM: ${{ needs.route.outputs.issue_num }}
          IS_PR: ${{ needs.route.outputs.is_pr }}
          REPO: ${{ github.repository }}
        run: |
          # All values passed via env to prevent code injection
          echo "ğŸ¤– Querying Ollama..."
          
          # Call Ollama API
          RESPONSE=$(curl -sf --max-time 60 \
            -H "Authorization: Bearer $OLLAMA_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg prompt "$TASK" '{
              model: "llama3.2",
              messages: [
                {role: "system", content: "You are a helpful coding assistant. Be concise."},
                {role: "user", content: $prompt}
              ],
              stream: false
            }')" \
            "$OLLAMA_API_URL/api/chat" 2>&1) || RESPONSE=""
          
          if [ -z "$RESPONSE" ]; then
            ANSWER="_(Ollama API unavailable)_"
          else
            ANSWER=$(echo "$RESPONSE" | jq -r '.message.content // "No response"')
          fi
          
          BODY="ğŸ¤– **Ollama Response**

          $ANSWER

          ---
          <sub>Model: llama3.2 | Cost: ~$0.001</sub>"
          
          # Post result
          if [ "$IS_PR" = "true" ]; then
            gh pr comment $ISSUE_NUM --repo "${{ github.repository }}" --body "$BODY"
          else
            gh issue comment $ISSUE_NUM --repo "${{ github.repository }}" --body "$BODY"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STATE TRANSITION: Handle label changes on tracking issues
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  state-transition:
    name: State Transition
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      contains(github.event.issue.labels.*.name, 'synthesis')
    runs-on: ubuntu-latest
    steps:
      - name: Handle State Change
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"
          LABEL="${{ github.event.label.name }}"
          
          echo "ğŸ·ï¸ Label added: $LABEL on issue #$ISSUE_NUM"
          
          case "$LABEL" in
            queue-ready)
              echo "  â†’ Triggering merge assessment"
              # The merge workflow will pick this up
              ;;
            queue-blocked)
              echo "  â†’ PR is blocked by critical issues"
              ;;
            queue-review)
              echo "  â†’ PR needs review attention"
              ;;
          esac

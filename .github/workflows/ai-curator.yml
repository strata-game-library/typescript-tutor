# AI Curator - Daily/event-driven curation pipeline
# Tier 1: Ollama (fast triage) via control-center
# Tier 2: Claude (issue analysis, deduplication)
# Tier 3: Jules (scheduled maintenance tasks)
# Synced from jbcom/control-center
name: AI Curator

on:
  issues:
    types: [opened, labeled]
  schedule:
    - cron: '0 3 * * *'  # 3 AM UTC daily
  workflow_dispatch:
    inputs:
      mode:
        description: 'Curation mode'
        type: choice
        options:
          - full
          - triage-only
        default: full

# No workflow-level permissions - job level only
permissions: {}

jobs:
  # ════════════════════════════════════════════════════════════════
  # EVENT: New Issue Triage (Claude)
  # ════════════════════════════════════════════════════════════════
  claude-triage:
    name: Claude Issue Triage
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: claude-triage-${{ github.event.issue.number }}
      cancel-in-progress: true
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - name: Check API Key
        id: check-key
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::ANTHROPIC_API_KEY not configured"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check-key.outputs.available == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Triage with Claude
        if: steps.check-key.outputs.available == 'true'
        uses: anthropics/claude-code-action@c9ec2b02b40ac0444c6716e51d5e19ef2e0b8d00 # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: "cursor[bot],jules[bot],google-labs-jules[bot],copilot-swe-agent[bot],dependabot[bot],renovate[bot],github-actions[bot]"
          prompt: |
            Triage issue #${{ github.event.issue.number }} in ${{ github.repository }}.
            
            1. Add appropriate labels (bug/enhancement/docs, priority)
            2. Check for duplicates - link and close if duplicate
            3. Add a helpful acknowledgment comment

          claude_args: |
            --allowedTools "Read,Glob,Grep,LS,Bash(gh:*),mcp__github__get_issue,mcp__github__update_issue,mcp__github__add_issue_comment,mcp__github__list_issues,mcp__github__search_issues"

  # ════════════════════════════════════════════════════════════════
  # SCHEDULED: Ollama Curation (control-center)
  # ════════════════════════════════════════════════════════════════
  build:
    name: Build Control Center
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && inputs.mode != 'triage-only')
    permissions:
      contents: read
    uses: jbcom/control-center/.github/workflows/control-center-build.yml@main

  ollama-curate:
    name: Ollama Curation
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Download binary
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: control-center-binary
          path: /tmp
          run-id: ${{ github.run_id }}
          github-token: ${{ secrets.CI_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Run curator
        env:
          GITHUB_TOKEN: ${{ secrets.CI_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          chmod +x /tmp/control-center
          /tmp/control-center curator \
            --repo "${{ github.repository }}" \
            --log-level info

  # ════════════════════════════════════════════════════════════════
  # SCHEDULED: Claude Issue Deduplication
  # ════════════════════════════════════════════════════════════════
  claude-dedup:
    name: Claude Deduplication
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: claude-dedup
      cancel-in-progress: true
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - name: Check API Key
        id: check-key
        run: |
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        if: steps.check-key.outputs.available == 'true'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Dedup with Claude
        if: steps.check-key.outputs.available == 'true'
        uses: anthropics/claude-code-action@c9ec2b02b40ac0444c6716e51d5e19ef2e0b8d00 # v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: "cursor[bot],jules[bot],google-labs-jules[bot],copilot-swe-agent[bot],dependabot[bot],renovate[bot],github-actions[bot]"
          prompt: |
            Scan ${{ github.repository }} for duplicate issues.
            
            Find similar issues, link duplicates to the canonical issue, and close them.

          claude_args: |
            --allowedTools "Read,Glob,Grep,LS,Bash(gh:*),mcp__github__list_issues,mcp__github__search_issues,mcp__github__get_issue,mcp__github__update_issue,mcp__github__add_issue_comment"

  # ════════════════════════════════════════════════════════════════
  # EVENT: Jules Bug Fixer (on 'bug' label)
  # ════════════════════════════════════════════════════════════════
  jules-bug-fix:
    name: Jules Bug Fixer
    if: |
      github.event_name == 'issues' &&
      github.event.action == 'labeled' &&
      github.event.label.name == 'bug'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      issues: read
      id-token: write
    steps:
      - name: Check API Key
        id: check-key
        run: |
          if [ -n "${{ secrets.GOOGLE_JULES_API_KEY }}" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      - name: Fix Bug with Jules
        if: steps.check-key.outputs.available == 'true'
        uses: google-labs-code/jules-action@bff7875eaa123cac6742b7cfc51005b95ba4d566 # v1.0.0
        with:
          jules_api_key: ${{ secrets.GOOGLE_JULES_API_KEY }}
          starting_branch: 'main'
          prompt: |
            Fix issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            
            ${{ github.event.issue.body }}
            
            Create a PR on branch `jules/fix-issue-${{ github.event.issue.number }}` with labels `jules-pr`, `bug-fix`.
            PR body must include: Fixes #${{ github.event.issue.number }}, root cause, and solution.
